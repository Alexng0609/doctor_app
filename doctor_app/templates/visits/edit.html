{% extends 'base.html' %}
{% block content %}
<div style="margin-bottom: 20px;">
    <a href="{{ url_for('patients.patient_detail', patient_id=visit.patient_id) }}" style="color: #007bff; text-decoration: none;">‚Üê Back to {{ visit.patient.full_name }}</a>
</div>

<h1>Edit Visit for {{ visit.patient.full_name }}</h1>
<p style="color: #666; margin-bottom: 20px;">Visit Date: {{ visit.visit_date.strftime('%B %d, %Y at %I:%M %p') }}</p>

<div id="validationError" style="display: none; background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
    <strong>‚ùå Cannot Save Visit - Please Fix These Errors:</strong>
    <div id="validationMessage" style="margin: 10px 0 0 0;"></div>
</div>

<form method="post" id="visitForm">
    {{ form.hidden_tag() }}
    
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="margin-top: 0;">Visit Information</h3>
        
        <div class="form-group">
            {{ form.clinician.label }}
            {{ form.clinician(class="form-control", placeholder="e.g., Dr. John Smith") }}
        </div>
        
        <div class="form-group">
            {{ form.notes.label }}
            {{ form.notes(class="form-control", rows="6", placeholder="Enter clinical notes, symptoms, observations, treatment plan, etc.") }}
        </div>
    </div>
    
    <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">Diagnoses</h3>
            <button type="button" onclick="addDiagnosis()" class="btn" style="background: #28a745; padding: 8px 15px;">+ Add Diagnosis</button>
        </div>
        
        <div id="diagnosesContainer">
            {% for i in range(1, 6) %}
            {% set code_val = form['diagnosis_code_' ~ i].data %}
            {% set desc_val = form['diagnosis_desc_' ~ i].data %}
            {% if code_val or desc_val %}
            <div class="diagnosis-row" id="diagnosis-{{ i }}" style="border-bottom: 1px solid #ddd; padding-bottom: 15px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #666; margin: 0;">Diagnosis {{ i }}</h4>
                    {% if i > 1 %}
                    <button type="button" onclick="removeDiagnosis({{ i }})" class="btn" style="background: #dc3545; padding: 5px 10px; font-size: 13px;">Remove</button>
                    {% endif %}
                </div>
                <div style="display: grid; grid-template-columns: 1fr 3fr; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        {{ form['diagnosis_code_' ~ i].label }}
                        {{ form['diagnosis_code_' ~ i](class="form-control", placeholder="e.g., R51") }}
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        {{ form['diagnosis_desc_' ~ i].label }}
                        {{ form['diagnosis_desc_' ~ i](class="form-control", placeholder="e.g., Headache") }}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        
        <p style="color: #856404; margin: 15px 0 0 0; font-size: 14px;">
            üí° <strong>Tip:</strong> Click "+ Add Diagnosis" to add more diagnoses. You can add up to 5 diagnoses per visit.
        </p>
        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border-left: 3px solid #dc3545;">
            <strong>‚ö†Ô∏è Important:</strong> If you enter a diagnosis code, you must also provide a description. Empty diagnosis descriptions will not be saved.
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        {{ form.submit(class="btn") }}
        <a href="{{ url_for('patients.patient_detail', patient_id=visit.patient_id) }}" class="btn" style="background: #6c757d;">Cancel</a>
    </div>
</form>

<script>
let diagnosisCount = {{ visit.diagnoses|length if visit.diagnoses else 1 }};
const maxDiagnoses = 5;

function addDiagnosis() {
    if (diagnosisCount >= maxDiagnoses) {
        showError('Maximum of 5 diagnoses allowed per visit.');
        return;
    }
    
    diagnosisCount++;
    const container = document.getElementById('diagnosesContainer');
    
    const diagnosisDiv = document.createElement('div');
    diagnosisDiv.className = 'diagnosis-row';
    diagnosisDiv.style.cssText = 'border-bottom: 1px solid #ddd; padding-bottom: 15px; margin-bottom: 15px;';
    diagnosisDiv.id = `diagnosis-${diagnosisCount}`;
    
    diagnosisDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4 style="color: #666; margin: 0;">Diagnosis ${diagnosisCount}</h4>
            <button type="button" onclick="removeDiagnosis(${diagnosisCount})" class="btn" style="background: #dc3545; padding: 5px 10px; font-size: 13px;">Remove</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 3fr; gap: 10px;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="diagnosis_code_${diagnosisCount}">Diagnosis Code ${diagnosisCount}</label>
                <input class="form-control" id="diagnosis_code_${diagnosisCount}" name="diagnosis_code_${diagnosisCount}" placeholder="e.g., R51" type="text" value="">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="diagnosis_desc_${diagnosisCount}">Diagnosis Description ${diagnosisCount}</label>
                <input class="form-control" id="diagnosis_desc_${diagnosisCount}" name="diagnosis_desc_${diagnosisCount}" placeholder="e.g., Headache" type="text" value="">
            </div>
        </div>
    `;
    
    container.appendChild(diagnosisDiv);
    hideError();
}

function removeDiagnosis(number) {
    const diagnosisDiv = document.getElementById(`diagnosis-${number}`);
    if (diagnosisDiv) {
        diagnosisDiv.remove();
        diagnosisCount--;
    }
    hideError();
}

function showError(message) {
    const errorDiv = document.getElementById('validationError');
    const messageP = document.getElementById('validationMessage');
    messageP.innerHTML = message;
    errorDiv.style.display = 'block';
    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function hideError() {
    const errorDiv = document.getElementById('validationError');
    errorDiv.style.display = 'none';
}

// Validate form before submission
document.getElementById('visitForm').addEventListener('submit', function(e) {
    hideError();
    
    let hasError = false;
    let errorMessages = [];
    
    for (let i = 1; i <= maxDiagnoses; i++) {
        const codeInput = document.getElementById('diagnosis_code_' + i);
        const descInput = document.getElementById('diagnosis_desc_' + i);
        
        if (codeInput && descInput) {
            const code = codeInput.value.trim();
            const desc = descInput.value.trim();
            
            if (code || desc) {
                if (!desc) {
                    hasError = true;
                    errorMessages.push(`Diagnosis ${i}: Description is required. Please fill in the diagnosis description or remove this diagnosis.`);
                    descInput.style.border = '2px solid #dc3545';
                } else if (desc.length < 3) {
                    hasError = true;
                    errorMessages.push(`Diagnosis ${i}: Description must be at least 3 characters long.`);
                    descInput.style.border = '2px solid #dc3545';
                }
            }
        }
    }
    
    if (hasError) {
        e.preventDefault();
        showError(errorMessages.join('<br>'));
        return false;
    }
    
    return true;
});

// Remove error highlight when user types
document.addEventListener('input', function(e) {
    if (e.target.id && e.target.id.startsWith('diagnosis_desc_')) {
        e.target.style.border = '';
        hideError();
    }
});
</script>
{% endblock %}