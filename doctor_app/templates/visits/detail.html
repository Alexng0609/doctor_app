{% extends 'base.html' %}
{% block content %}
<div style="margin-bottom: 20px;">
    <a href="{{ url_for('patients.patient_detail', patient_id=visit.patient.id) }}" style="color: #007bff; text-decoration: none;">‚Üê Back to {{ visit.patient.full_name }}</a>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1 style="margin: 0;">Visit Details</h1>
    <div style="display: flex; gap: 10px;">
        <a href="{{ url_for('visits.edit_visit', visit_id=visit.id) }}" class="btn" style="background: #ffc107; color: #000;">Edit Visit</a>
        <form method="post" action="{{ url_for('visits.delete_visit', visit_id=visit.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this visit? All diagnoses will also be deleted. This action cannot be undone.');">
            <button type="submit" class="btn" style="background: #dc3545;">Delete Visit</button>
        </form>
    </div>
</div>

<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div>
            <strong style="color: #666;">Patient:</strong>
            <p style="margin: 5px 0;">
                <a href="{{ url_for('patients.patient_detail', patient_id=visit.patient.id) }}" style="color: #007bff; text-decoration: none;">
                    {{ visit.patient.full_name }}
                </a>
            </p>
        </div>
        <div>
            <strong style="color: #666;">Visit Date:</strong>
            <p style="margin: 5px 0;">{{ visit.visit_date.strftime('%B %d, %Y at %I:%M %p') }}</p>
        </div>
        <div>
            <strong style="color: #666;">Clinician:</strong>
            <p style="margin: 5px 0;">{{ visit.clinician or '‚Äî' }}</p>
        </div>
        {% if visit.creator %}
        <div>
            <strong style="color: #666;">Created By:</strong>
            <p style="margin: 5px 0;">{{ visit.creator.full_name or visit.creator.username }}</p>
        </div>
        {% endif %}
    </div>
</div>

<div style="margin-bottom: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 style="margin: 0;">Clinical Notes</h2>
    </div>
    
    <form method="post">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.notes(class="form-control", rows="8", placeholder="Enter clinical notes, symptoms, observations, treatment plan, etc.") }}
            {% if form.notes.errors %}
                <ul class="errors">
                    {% for error in form.notes.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        {{ form.submit(class="btn", style="background: #28a745;") }}
    </form>
</div>

<div style="margin-bottom: 30px;">
    <h2>Diagnoses</h2>
    {% if diagnoses %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #007bff; color: white;">
                <th style="padding: 12px; text-align: left; border: 1px solid #0056b3; width: 150px;">Code</th>
                <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Description</th>
            </tr>
        </thead>
        <tbody>
            {% for d in diagnoses %}
            <tr>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    {% if d.code %}
                        <strong style="color: #007bff;">{{ d.code }}</strong>
                    {% else %}
                        <span style="color: #999;">‚Äî</span>
                    {% endif %}
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ d.description }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
        <strong>Total Diagnoses:</strong> {{ diagnoses|length }}
    </div>
    {% else %}
    <div style="padding: 30px; text-align: center; background: #f9f9f9; border-radius: 8px; border: 1px dashed #ddd;">
        <p style="font-size: 16px; color: #666; margin: 0;">No diagnoses recorded for this visit.</p>
    </div>
    {% endif %}
</div>

<div style="margin-top: 30px;">
    <a href="{{ url_for('patients.patient_detail', patient_id=visit.patient.id) }}" class="btn" style="background: #6c757d;">Back to Patient</a>
</div>

<div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
    <strong>üí° Note:</strong> Diagnoses cannot be edited after the visit is created. If you need to change diagnoses, please create a new visit.
</div>
{% endblock %}