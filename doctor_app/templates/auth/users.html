{% extends 'base.html' %}
{% block content %}
<h1>User Management</h1>

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('auth.register') }}" class="btn">Add New User</a>
</div>

<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background: #007bff; color: white;">
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Username</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Full Name</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Email</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd; width: 250px;">Location/Clinic Address</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Role</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Status</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Created</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr style="{% if not user.is_active %}opacity: 0.6;{% endif %}">
            <td style="padding: 10px; border: 1px solid #ddd;">
                <strong>{{ user.username }}</strong>
                {% if user.id == current_user.id %}<span style="color: #28a745; font-size: 12px;">(You)</span>{% endif %}
            </td>
            <td style="padding: 10px; border: 1px solid #ddd;">{{ user.full_name or '‚Äî' }}</td>
            <td style="padding: 10px; border: 1px solid #ddd;">{{ user.email or '‚Äî' }}</td>
            <td style="padding: 10px; border: 1px solid #ddd; vertical-align: top;">
                {# Display mode #}
                <div id="location-display-{{ user.id }}" style="display: block;">
                    {% if user.location %}
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 8px; border-left: 3px solid #17a2b8;">
                            <div style="font-weight: bold; color: #17a2b8; margin-bottom: 5px;">
                                üìç Location Address:
                            </div>
                            <div style="white-space: pre-line; font-size: 13px; line-height: 1.5;">{{ user.location }}</div>
                        </div>
                    {% else %}
                        <div style="color: #999; font-style: italic; padding: 10px;">No address set</div>
                    {% endif %}
                    <button onclick="editLocation({{ user.id }}, `{{ user.location|replace('`', '\\`')|replace('\n', '\\n') if user.location else '' }}`)" 
                            class="btn" 
                            style="padding: 6px 12px; font-size: 12px; background: #6c757d; width: 100%;">
                        ‚úèÔ∏è Edit Address
                    </button>
                </div>
                
                {# Edit mode #}
                <form id="location-form-{{ user.id }}" 
                      method="post" 
                      action="{{ url_for('auth.update_location', user_id=user.id) }}"
                      style="display: none;">
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 13px;">
                            üìç Full Address:
                        </label>
                        <textarea name="location" 
                                  id="location-input-{{ user.id }}"
                                  rows="4"
                                  placeholder="Enter full address:&#10;Street Address&#10;City, State ZIP&#10;Country (if applicable)"
                                  style="width: 100%; padding: 8px; border: 2px solid #17a2b8; border-radius: 4px; font-size: 13px; font-family: inherit; resize: vertical;"></textarea>
                        <small style="color: #666; font-size: 11px;">
                            üí° Tip: Use multiple lines for better readability
                        </small>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button type="submit" 
                                class="btn" 
                                style="flex: 1; padding: 8px; font-size: 13px; background: #28a745;">
                            ‚úì Save Address
                        </button>
                        <button type="button" 
                                onclick="cancelEdit({{ user.id }})"
                                class="btn" 
                                style="flex: 1; padding: 8px; font-size: 13px; background: #dc3545;">
                            ‚úó Cancel
                        </button>
                    </div>
                </form>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd;">
                <span style="padding: 4px 8px; border-radius: 3px; font-size: 12px; {% if user.role == 'admin' %}background: #ffc107; color: #000;{% else %}background: #007bff; color: white;{% endif %}">
                    {{ user.role|upper }}
                </span>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd;">
                <span style="padding: 4px 8px; border-radius: 3px; font-size: 12px; {% if user.is_active %}background: #28a745; color: white;{% else %}background: #dc3545; color: white;{% endif %}">
                    {{ 'Active' if user.is_active else 'Inactive' }}
                </span>
            </td>
            <td style="padding: 10px; border: 1px solid #ddd;">{{ user.created_at.strftime('%b %d, %Y') }}</td>
            <td style="padding: 10px; border: 1px solid #ddd;">
                <a href="{{ url_for('auth.edit_user', user_id=user.id) }}" class="btn" style="padding: 5px 10px; font-size: 13px; margin-right: 5px;">Edit All</a>
                {% if user.id != current_user.id %}
                <form method="post" action="{{ url_for('auth.delete_user', user_id=user.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this user?');">
                    <button type="submit" class="btn" style="padding: 5px 10px; font-size: 13px; background: #dc3545;">Delete</button>
                </form>
                {% endif %}
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="8" style="padding: 20px; text-align: center; border: 1px solid #ddd;">No users found</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 5px;">
    <strong>Total Users:</strong> {{ users|length }}
</div>

<div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
    <strong>üí° Quick Address Edit:</strong> Click "‚úèÔ∏è Edit Address" to update a user's location directly from this page. You can enter full multi-line addresses for better organization.
</div>

<script>
function editLocation(userId, currentLocation) {
    // Hide display, show form
    document.getElementById('location-display-' + userId).style.display = 'none';
    document.getElementById('location-form-' + userId).style.display = 'block';
    
    // Set textarea value and focus
    const textarea = document.getElementById('location-input-' + userId);
    // Decode escaped newlines back to actual newlines
    textarea.value = currentLocation.replace(/\\n/g, '\n').replace(/\\`/g, '`');
    textarea.focus();
    
    // Move cursor to end
    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
}

function cancelEdit(userId) {
    // Show display, hide form
    document.getElementById('location-display-' + userId).style.display = 'block';
    document.getElementById('location-form-' + userId).style.display = 'none';
}

// Allow Escape to cancel
document.addEventListener('keydown', function(e) {
    if (e.target.name === 'location' && e.key === 'Escape') {
        const userId = e.target.id.replace('location-input-', '');
        cancelEdit(userId);
    }
});

// Auto-resize textareas as user types
document.addEventListener('input', function(e) {
    if (e.target.name === 'location' && e.target.tagName === 'TEXTAREA') {
        e.target.style.height = 'auto';
        e.target.style.height = (e.target.scrollHeight) + 'px';
    }
});
</script>
{% endblock %}