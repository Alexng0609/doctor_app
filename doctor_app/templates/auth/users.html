{% extends 'base.html' %}
{% block content %}
<h1>User Management</h1>

<div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <a href="{{ url_for('auth.register') }}" class="btn">+ Create Doctor</a>
    <div style="color: #666;">
        <strong>Showing:</strong> Doctors only (Assistants managed by their doctors)
    </div>
</div>

<div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
        <thead>
            <tr style="background: #007bff; color: white;">
                <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Username</th>
                <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Full Name</th>
                <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Email</th>
                <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Location/Clinic</th>
                <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Assistants</th>
                <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Status</th>
                <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Created</th>
                <th style="padding: 12px; text-align: center; border: 1px solid #0056b3;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            {% if user.role != 'assistant' %}
            <tr class="user-row" data-user-id="{{ user.id }}" style="{% if not user.is_active %}opacity: 0.6;{% endif %} cursor: pointer;">
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <strong style="color: #007bff;">{{ user.username }}</strong>
                    {% if user.id == current_user.id %}
                    <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">YOU</span>
                    {% endif %}
                    {% if user.role == 'admin' %}
                    <span style="background: #ffc107; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">üëë ADMIN</span>
                    {% endif %}
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ user.full_name or '‚Äî' }}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ user.email or '‚Äî' }}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    {% if user.location %}
                        <div style="background: #17a2b8; color: white; padding: 6px 10px; border-radius: 5px; font-size: 12px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            üìç {{ user.location }}
                        </div>
                    {% else %}
                        <span style="color: #999; font-style: italic;">No location set</span>
                    {% endif %}
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;" onclick="event.stopPropagation();">
                    {% if user.role == 'doctor' %}
                        {% set assistant_list = user.assistants.all() %}
                        {% set assistant_count = assistant_list|length %}
                        {% if assistant_count > 0 %}
                            <button class="btn-small" onclick="toggleAssistants({{ user.id }})" style="background: #17a2b8;">
                                üë• {{ assistant_count }} Assistant{{ 's' if assistant_count != 1 else '' }}
                            </button>
                        {% else %}
                            <span style="color: #999; font-size: 12px;">None</span>
                        {% endif %}
                    {% else %}
                        <span style="color: #999;">‚Äî</span>
                    {% endif %}
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    {% if user.is_active %}
                        <span style="background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                            ‚óè Active
                        </span>
                    {% else %}
                        <span style="background: #dc3545; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                            ‚óè Inactive
                        </span>
                    {% endif %}
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ user.created_at.strftime('%b %d, %Y') }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;" onclick="event.stopPropagation();">
                    <a href="{{ url_for('auth.edit_user', user_id=user.id) }}" class="btn-small">‚úèÔ∏è Edit</a>
                    {% if user.id != current_user.id %}
                    {% set assistant_list = user.assistants.all() if user.role == 'doctor' else [] %}
                    <form method="post" action="{{ url_for('auth.delete_user', user_id=user.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete {{ user.username }}?{% if user.role == 'doctor' and assistant_list|length > 0 %}\n\nThis doctor has {{ assistant_list|length }} assistant(s). You must delete or reassign them first.{% endif %}');">
                        <button type="submit" class="btn-small btn-danger" {% if user.role == 'doctor' and assistant_list|length > 0 %}disabled style="background: #6c757d; cursor: not-allowed;" title="Cannot delete: has assistants"{% endif %}>
                            üóëÔ∏è Delete
                        </button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            
            {# Expandable assistant list row #}
            {% if user.role == 'doctor' %}
            {% set assistant_list = user.assistants.all() %}
            {% if assistant_list|length > 0 %}
            <tr id="assistants-row-{{ user.id }}" class="assistants-row" style="display: none; background: #f8f9fa;">
                <td colspan="8" style="padding: 20px; border: 1px solid #ddd;">
                    <div style="margin-bottom: 10px;">
                        <strong style="color: #007bff;">üë• Assistants under {{ user.full_name or user.username }}:</strong>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; background: white;">
                        <thead>
                            <tr style="background: #17a2b8; color: white;">
                                <th style="padding: 8px; text-align: left; border: 1px solid #117a8b;">Username</th>
                                <th style="padding: 8px; text-align: left; border: 1px solid #117a8b;">Full Name</th>
                                <th style="padding: 8px; text-align: left; border: 1px solid #117a8b;">Email</th>
                                <th style="padding: 8px; text-align: left; border: 1px solid #117a8b;">Status</th>
                                <th style="padding: 8px; text-align: left; border: 1px solid #117a8b;">Patients</th>
                                <th style="padding: 8px; text-align: left; border: 1px solid #117a8b;">Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assistant in assistant_list %}
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">
                                    <strong>{{ assistant.username }}</strong>
                                </td>
                                <td style="padding: 8px; border: 1px solid #ddd;">{{ assistant.full_name }}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">{{ assistant.email or '‚Äî' }}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">
                                    {% if assistant.is_active %}
                                        <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">‚óè Active</span>
                                    {% else %}
                                        <span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">‚óè Inactive</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 8px; border: 1px solid #ddd;">
                                    <span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                                        {{ assistant.patients|length }}
                                    </span>
                                </td>
                                <td style="padding: 8px; border: 1px solid #ddd;">{{ assistant.created_at.strftime('%b %d, %Y') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </td>
            </tr>
            {% endif %}
            {% endif %}
            {% endif %}
            {% else %}
            <tr>
                <td colspan="8" style="padding: 20px; text-align: center; border: 1px solid #ddd;">No doctors found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 5px;">
    <strong>Total Doctors:</strong> {{ users|selectattr('role', 'ne', 'assistant')|list|length }}
    <span style="margin-left: 15px; color: #666;">üí° Click on any row to edit user | Click assistant count to view details</span>
</div>

<div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
    <strong>‚ÑπÔ∏è Note:</strong> Assistants are managed by their doctors through "My Assistants" menu. Only doctors and admins are shown here. Doctors with assistants cannot be deleted until their assistants are removed or reassigned.
</div>

<script>
// Toggle assistant list visibility
function toggleAssistants(userId) {
    const row = document.getElementById('assistants-row-' + userId);
    if (row.style.display === 'none' || row.style.display === '') {
        row.style.display = 'table-row';
    } else {
        row.style.display = 'none';
    }
}

// Make table rows clickable
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('.user-row');
    
    rows.forEach(row => {
        // Add hover effect
        row.addEventListener('mouseenter', function() {
            if (!this.style.opacity || this.style.opacity === '1') {
                this.style.backgroundColor = '#f0f8ff';
            }
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
        
        // Make row clickable (navigate to edit page)
        row.addEventListener('click', function(e) {
            // Don't navigate if clicking on buttons, forms, or links
            if (e.target.tagName !== 'BUTTON' && 
                e.target.tagName !== 'FORM' && 
                e.target.tagName !== 'A' && 
                !e.target.closest('button') && 
                !e.target.closest('form') &&
                !e.target.closest('a')) {
                const userId = this.getAttribute('data-user-id');
                window.location.href = "{{ url_for('auth.edit_user', user_id=0) }}".replace('0', userId);
            }
        });
    });
});
</script>

<style>
.btn-small {
    padding: 6px 12px;
    font-size: 13px;
    text-decoration: none;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: inline-block;
    margin: 0 2px;
}

.btn-small:hover {
    background: #0056b3;
}

.btn-danger {
    background: #dc3545;
}

.btn-danger:hover {
    background: #c82333;
}

.assistants-row {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Dark mode support */
body.dark-mode table {
    background: #2d2d2d !important;
}

body.dark-mode table thead tr {
    background: #0056b3 !important;
}

body.dark-mode table tbody tr {
    background: #2d2d2d !important;
}

body.dark-mode table tbody tr:hover,
body.dark-mode .user-row:hover {
    background: #3d3d3d !important;
}

body.dark-mode table td,
body.dark-mode table th {
    border-color: #444 !important;
    color: #e0e0e0 !important;
}

body.dark-mode .assistants-row {
    background: #1a1a1a !important;
}

body.dark-mode .assistants-row table {
    background: #2d2d2d !important;
}

body.dark-mode .assistants-row thead tr {
    background: #117a8b !important;
}
</style>
{% endblock %}