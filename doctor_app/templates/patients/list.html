{% extends 'base.html' %}
{% block content %}
<h1>Patients</h1>
<div class="search-bar" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
  <form method="get" style="display: flex; gap: 10px; flex: 1;">
    <input name="q" value="{{ q }}" placeholder="Search by name or phone" style="flex: 1;">
    <button type="submit" class="btn">Search</button>
  </form>
  <a href="{{ url_for('patients.new_patient') }}" class="btn">+ New Patient</a>
</div>

{% if patients %}
<div style="overflow-x: auto;">
  <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
    <thead>
      <tr style="background: #007bff; color: white;">
        <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">#</th>
        <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Name</th>
        <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Phone Number</th>
        <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Date of Birth</th>
        <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Age</th>
        {% if q %}
        <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Primary Doctor</th>
        <th style="padding: 12px; text-align: left; border: 1px solid #0056b3; min-width: 200px;">Location</th>
        {% endif %}
        <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Last Visit</th>
        <th style="padding: 12px; text-align: left; border: 1px solid #0056b3;">Total Visits</th>
        {% if q %}
        <th style="padding: 12px; text-align: center; border: 1px solid #0056b3;">Action</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for p in patients %}
      <tr class="patient-row" data-patient-id="{{ p.id }}" style="{% if p.doctor_id != current_user.id %}background: #fff3cd;{% endif %} cursor: pointer;">
        <td style="padding: 10px; border: 1px solid #ddd;">{{ loop.index }}</td>
        <td style="padding: 10px; border: 1px solid #ddd;">
          <strong style="color: #007bff;">{{ p.full_name }}</strong>
          {% if p.doctor_id != current_user.id %}
            <span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px;">OTHER DOCTOR</span>
          {% endif %}
        </td>
        <td style="padding: 10px; border: 1px solid #ddd;">
          {{ p.phone or '‚Äî' }}
        </td>
        <td style="padding: 10px; border: 1px solid #ddd;">
          {% if p.date_of_birth %}
            {{ p.date_of_birth.strftime('%b %d, %Y') }}
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td style="padding: 10px; border: 1px solid #ddd;">
          {% if p.date_of_birth %}
            {% set age = ((now.year - p.date_of_birth.year) - ((now.month, now.day) < (p.date_of_birth.month, p.date_of_birth.day))) %}
            {{ age }} years
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        {% if q %}
        <td style="padding: 10px; border: 1px solid #ddd;">
          {% if p.primary_doctor %}
            {{ p.primary_doctor.full_name or p.primary_doctor.username }}
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td style="padding: 10px; border: 1px solid #ddd; vertical-align: top;">
          {% if p.primary_doctor and p.primary_doctor.location %}
            {% if p.doctor_id == current_user.id %}
              {# Patient belongs to current user - show green badge #}
              <div style="background: #28a745; color: white; padding: 8px 10px; border-radius: 5px; font-size: 12px; border-left: 3px solid #1e7e34;">
                <div style="font-weight: bold; margin-bottom: 3px;">üìç Your Location:</div>
                <div style="font-size: 11px; line-height: 1.4; white-space: pre-line;">{{ p.primary_doctor.location.split('\n')[0] }}{% if p.primary_doctor.location.count('\n') > 0 %}...{% endif %}</div>
              </div>
            {% else %}
              {# Patient belongs to another doctor - show blue badge #}
              <div style="background: #17a2b8; color: white; padding: 8px 10px; border-radius: 5px; font-size: 12px; border-left: 3px solid #117a8b;">
                <div style="font-weight: bold; margin-bottom: 3px;">üìç Location:</div>
                <div style="font-size: 11px; line-height: 1.4; white-space: pre-line;">{{ p.primary_doctor.location.split('\n')[0] }}{% if p.primary_doctor.location.count('\n') > 0 %}...{% endif %}</div>
              </div>
            {% endif %}
            {# Show full address on hover #}
            {% if p.primary_doctor.location.count('\n') > 0 %}
              <small style="color: #666; font-size: 10px; display: block; margin-top: 3px; font-style: italic;">
                Hover for full address
              </small>
            {% endif %}
          {% elif p.primary_doctor %}
            {# Doctor exists but no location set #}
            <span style="background: #6c757d; color: white; padding: 6px 10px; border-radius: 3px; font-size: 12px; display: inline-block;">
              üìç No Address Set
            </span>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        {% endif %}
        <td style="padding: 10px; border: 1px solid #ddd;">
          {% if p.visits %}
            {% set last_visit = p.visits|sort(attribute='visit_date', reverse=True)|first %}
            {{ last_visit.visit_date.strftime('%b %d, %Y') }}
          {% else %}
            <span style="color: #999;">No visits</span>
          {% endif %}
        </td>
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
          <span style="background: #007bff; color: white; padding: 4px 12px; border-radius: 12px; font-size: 13px;">
            {{ p.visits|length }}
          </span>
        </td>
        {% if q %}
        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;" onclick="event.stopPropagation();">
          {% if p.doctor_id != current_user.id %}
            {# Patient belongs to another doctor - show "Add to My Patients" button #}
            <form method="post" action="{{ url_for('patients.add_patient_to_my_list', patient_id=p.id) }}" style="display: inline;">
              <button type="submit" class="btn" style="background: #28a745; padding: 6px 12px; font-size: 12px;" onclick="return confirm('Add {{ p.full_name }} to your patient list?\n\nThis will allow you to manage visits for this patient.');">
                ‚ûï Add to My Patients
              </button>
            </form>
          {% else %}
            {# Patient already belongs to current user #}
            <span style="background: #28a745; color: white; padding: 6px 12px; border-radius: 3px; font-size: 12px;">
              ‚úì Your Patient
            </span>
          {% endif %}
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 5px;">
  <strong>Total Patients:</strong> {{ patients|length }}
  {% if q %}
  <span style="margin-left: 10px; color: #666;">| Showing search results for "{{ q }}"</span>
  <a href="{{ url_for('patients.list_patients') }}" style="margin-left: 10px; color: #007bff;">Clear search</a>
  {% else %}
  <span style="margin-left: 10px; color: #666;">| Showing patients from your location</span>
  {% endif %}
  <span style="margin-left: 15px; color: #666;">üí° Click on any row to view patient details</span>
</div>

{% if q %}
<div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
  <strong>üí° Search Tip:</strong> When searching, you can see patients from all locations. Click "‚ûï Add to My Patients" to add patients from other doctors to your list. This allows you to manage their visits while keeping track of their original doctor.
</div>
{% endif %}

{% else %}
<div style="padding: 40px; text-align: center; background: #f9f9f9; border-radius: 8px; margin-top: 20px;">
  <p style="font-size: 18px; color: #666;">
    {% if q %}
      No patients found matching "{{ q }}"
    {% else %}
      No patients yet. Click "+ New Patient" to add your first patient.
    {% endif %}
  </p>
  {% if q %}
  <a href="{{ url_for('patients.list_patients') }}" class="btn" style="margin-top: 10px;">Clear search</a>
  {% endif %}
</div>
{% endif %}

<script>
// Make table rows clickable (except when clicking buttons)
document.addEventListener('DOMContentLoaded', function() {
  const rows = document.querySelectorAll('.patient-row');
  
  rows.forEach(row => {
    // Add hover effect
    row.addEventListener('mouseenter', function() {
      this.style.backgroundColor = this.style.backgroundColor.includes('fff3cd') ? '#ffe082' : '#f0f8ff';
    });
    
    row.addEventListener('mouseleave', function() {
      this.style.backgroundColor = this.style.backgroundColor.includes('ffe082') ? '#fff3cd' : '';
    });
    
    // Make row clickable
    row.addEventListener('click', function(e) {
      // Don't navigate if clicking on a button or form
      if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'FORM' && !e.target.closest('button')) {
        const patientId = this.getAttribute('data-patient-id');
        window.location.href = "{{ url_for('patients.patient_detail', patient_id=0) }}".replace('0', patientId);
      }
    });
  });
});
</script>

<style>
/* Tooltip for full address on hover */
td[data-full-address] {
  position: relative;
}

td[data-full-address]:hover::after {
  content: attr(data-full-address);
  position: absolute;
  left: 0;
  top: 100%;
  background: #333;
  color: white;
  padding: 10px;
  border-radius: 5px;
  white-space: pre-line;
  z-index: 1000;
  font-size: 12px;
  max-width: 300px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
</style>
{% endblock %}