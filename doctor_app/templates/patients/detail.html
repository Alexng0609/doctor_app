{% extends 'base.html' %}
{% block content %}
<h1>Patient: {{ patient.full_name }}</h1>

<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div>
            <strong>Full Name:</strong><br>
            {{ patient.full_name }}
        </div>
        <div>
            <strong>Phone:</strong><br>
            {{ patient.phone or '—' }}
        </div>
        <div>
            <strong>Date of Birth:</strong><br>
            {% if patient.date_of_birth %}
                {{ patient.date_of_birth.strftime('%B %d, %Y') }}
            {% else %}
                —
            {% endif %}
        </div>
        <div>
            <strong>Age:</strong><br>
            {% if patient.date_of_birth %}
                {% set age = ((now.year - patient.date_of_birth.year) - ((now.month, now.day) < (patient.date_of_birth.month, patient.date_of_birth.day))) %}
                {{ age }} years
            {% else %}
                —
            {% endif %}
        </div>
    </div>
    
    {% if patient.primary_doctor %}
    <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px;">
        <strong>Assigned To:</strong> {{ patient.primary_doctor.full_name or patient.primary_doctor.username }}
        {% if patient.primary_doctor.location %}
            <br><strong>Location:</strong> 
            <div style="margin-top: 5px; color: #666; white-space: pre-line;">{{ patient.primary_doctor.location }}</div>
        {% endif %}
    </div>
    {% endif %}
</div>

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('patients.list_patients') }}" class="btn" style="background: #6c757d;">← Back to Patients</a>
    <a href="{{ url_for('patients.edit_patient', patient_id=patient.id) }}" class="btn">Edit Patient</a>
    <a href="{{ url_for('visits.new_visit', patient_id=patient.id) }}" class="btn" style="background: #28a745;">+ Add Visit</a>
    
    {# Only show delete button if user has permission #}
    {% if current_user.can_delete_patient() %}
    <form method="post" action="{{ url_for('patients.delete_patient', patient_id=patient.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this patient? This will also delete all visits and diagnoses.');">
        <button type="submit" class="btn" style="background: #dc3545;">Delete Patient</button>
    </form>
    {% else %}
    <button class="btn" style="background: #999; cursor: not-allowed;" disabled title="You don't have permission to delete patients">Delete Patient</button>
    {% endif %}
</div>

<h2>Visits ({{ visits|length }})</h2>

{% if visits %}
<div style="display: flex; flex-direction: column; gap: 15px;">
    {% for visit in visits|sort(attribute='visit_date', reverse=True) %}
    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
            <div>
                <h3 style="margin: 0 0 10px 0; color: #007bff;">
                    {{ visit.visit_date.strftime('%B %d, %Y') }}
                </h3>
                <div style="color: #666; font-size: 14px;">
                    <strong>Time:</strong> {{ visit.visit_date.strftime('%I:%M %p') }}
                    {% if visit.clinician %}
                    <br><strong>Clinician:</strong> {{ visit.clinician }}
                    {% endif %}
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="{{ url_for('visits.edit_visit', visit_id=visit.id) }}" class="btn" style="padding: 8px 15px; font-size: 14px;">Edit Visit</a>
            </div>
        </div>
        
        {% if visit.diagnoses %}
        <div style="margin-bottom: 15px;">
            <strong style="color: #333;">Diagnoses:</strong>
            <div style="margin-top: 8px;">
                {% for diagnosis in visit.diagnoses %}
                <div style="padding: 10px; background: #f8f9fa; border-left: 3px solid #007bff; margin-bottom: 8px; border-radius: 3px;">
                    {% if diagnosis.code %}
                    <strong style="color: #007bff;">{{ diagnosis.code }}:</strong>
                    {% endif %}
                    {{ diagnosis.description }}
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div style="padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; margin-bottom: 15px; border-radius: 3px;">
            <em>No diagnoses recorded for this visit</em>
        </div>
        {% endif %}
        
        {% if visit.notes %}
        <div>
            <strong style="color: #333;">Notes:</strong>
            <div style="margin-top: 8px; padding: 15px; background: #f8f9fa; border-radius: 5px; white-space: pre-wrap; line-height: 1.6;">{{ visit.notes }}</div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<div style="padding: 40px; text-align: center; background: #f9f9f9; border-radius: 8px; border: 2px dashed #ddd;">
    <p style="font-size: 18px; color: #666; margin-bottom: 20px;">No visits recorded yet</p>
    <a href="{{ url_for('visits.new_visit', patient_id=patient.id) }}" class="btn" style="background: #28a745;">+ Add First Visit</a>
</div>
{% endif %}
{% endblock %}